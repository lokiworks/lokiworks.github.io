(window.webpackJsonp=window.webpackJsonp||[]).push([[8],{77:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return i})),n.d(t,"metadata",(function(){return b})),n.d(t,"rightToc",(function(){return r})),n.d(t,"default",(function(){return s}));var a=n(3),l=n(7),c=(n(0),n(98)),i={slug:"database-version-management",title:"\u5de5\u7a0b\u5b9e\u8df5\u4e4b\u6570\u636e\u5e93\u811a\u672c\u7248\u672c\u7ba1\u7406",author:"Loki",author_title:"SE",author_url:"https://lokiworks.github.io",author_image_url:"https://avatars1.githubusercontent.com/u/16199375?v=4",tags:["source code"]},b={permalink:"/blog/database-version-management",editUrl:"https://github.com/facebook/docusaurus/edit/master/website/blog/blog/2020-09-26-database-version-management.md",source:"@site/blog/2020-09-26-database-version-management.md",description:"\u5df2\u7ecf\u597d\u4e45\u6ca1\u5199\u535a\u5ba2\u4e86\uff0c\u6700\u8fd1\u4e00\u76f4\u5728\u7814\u8bfbleveldb\u7684\u6e90\u7801\uff0c\u8fdb\u5c55\u4e0d\u662f\u5f88\u987a\u5229\u3002\u60f3\u8981\u5199\u51fa\u4e00\u7bc7\u81ea\u5df1\u7684\u89c1\u89e3\u8fd8\u8981\u4e00\u6bb5\u65f6\u95f4\u3002\u6b63\u597d\u6700\u8fd1\u5728\u6570\u636e\u5e93\u811a\u672c\u7248\u672c\u7ba1\u7406\u63a7\u5236\u65b9\u9762\u6709\u4e00\u4e9b\u81ea\u5df1\u7684\u60f3\u6cd5\u4e0e\u5b9e\u8df5\uff0c\u62ff\u51fa\u6765\u4e0e\u5404\u4f4d\u5206\u4eab\u3002",date:"2020-09-26T00:00:00.000Z",tags:[{label:"source code",permalink:"/blog/tags/source-code"}],title:"\u5de5\u7a0b\u5b9e\u8df5\u4e4b\u6570\u636e\u5e93\u811a\u672c\u7248\u672c\u7ba1\u7406",readingTime:1.9,truncated:!1,nextItem:{title:"\u5982\u4f55\u9605\u8bfb\u6e90\u7801",permalink:"/blog/how-to-read-sourcecode"}},r=[{value:"\u9700\u6c42",id:"\u9700\u6c42",children:[]},{value:"\u601d\u8def",id:"\u601d\u8def",children:[]},{value:"\u5b9e\u8df5",id:"\u5b9e\u8df5",children:[]},{value:"\u7ed3\u8bed",id:"\u7ed3\u8bed",children:[{value:"\u8054\u7cfb\u65b9\u5f0f",id:"\u8054\u7cfb\u65b9\u5f0f",children:[]}]}],o={rightToc:r};function s(e){var t=e.components,i=Object(l.a)(e,["components"]);return Object(c.b)("wrapper",Object(a.a)({},o,i,{components:t,mdxType:"MDXLayout"}),Object(c.b)("p",null,"\u5df2\u7ecf\u597d\u4e45\u6ca1\u5199\u535a\u5ba2\u4e86\uff0c\u6700\u8fd1\u4e00\u76f4\u5728\u7814\u8bfbleveldb\u7684\u6e90\u7801\uff0c\u8fdb\u5c55\u4e0d\u662f\u5f88\u987a\u5229\u3002\u60f3\u8981\u5199\u51fa\u4e00\u7bc7\u81ea\u5df1\u7684\u89c1\u89e3\u8fd8\u8981\u4e00\u6bb5\u65f6\u95f4\u3002\u6b63\u597d\u6700\u8fd1\u5728\u6570\u636e\u5e93\u811a\u672c\u7248\u672c\u7ba1\u7406\u63a7\u5236\u65b9\u9762\u6709\u4e00\u4e9b\u81ea\u5df1\u7684\u60f3\u6cd5\u4e0e\u5b9e\u8df5\uff0c\u62ff\u51fa\u6765\u4e0e\u5404\u4f4d\u5206\u4eab\u3002"),Object(c.b)("h2",{id:"\u9700\u6c42"},"\u9700\u6c42"),Object(c.b)("ul",null,Object(c.b)("li",{parentName:"ul"},"\u6570\u636e\u5e93\u811a\u672c\u53ef\u4ee5\u7528git\u8fdb\u884c\u7248\u672c\u7ba1\u7406"),Object(c.b)("li",{parentName:"ul"},"\u6570\u636e\u5e93\u811a\u672c\u53ef\u4ee5\u50cf\u666e\u901a\u4ee3\u7801\u4e00\u6837\u7eb3\u5165code review\u6d41\u7a0b(Gitlab\u3001Gerrit\u7b49)\u8fdb\u884c\u811a\u672c\u5408\u89c4\u7684\u5ba1\u67e5"),Object(c.b)("li",{parentName:"ul"},"\u6570\u636e\u5e93\u811a\u672c\u53ef\u4ee5\u4e0eCI\u96c6\u6210\uff0c\u4f5c\u4e3apipeline\u4e2d\u7684\u4e00\u4e2a\u73af\u8282\u3002\u901a\u8fc7\u4e0e\u4e0a\u4e00\u7248\u672c\u8fdb\u884c\u6bd4\u8f83,\u751f\u6210\u5f85\u4e0a\u7ebf\u7684\u811a\u672c\u53ca\u5bf9\u5e94\u7684\u56de\u9000\u811a\u672c\u3002")),Object(c.b)("h2",{id:"\u601d\u8def"},"\u601d\u8def"),Object(c.b)("p",null,"\u5173\u4e8e\u6570\u636e\u5e93\u811a\u672c\u7248\u672c\u7ba1\u7406\u65b9\u9762\u7684\u5de5\u5177\uff0c\u6211\u5728\u7f51\u4e0a\u4e5f\u641c\u4e86\u5f88\u591a\u5de5\u5177\uff0c\u6bd4\u5982\uff1aflyway\u3001liquibase\u3001uml\u5efa\u6a21\u5de5\u5177\u7b49\uff0c\u4f46\u662f\u8fd9\u4e9b\u5de5\u5177\u90fd\u4e0d\u662f\u6211\u60f3\u8981\u7684\u3002\u8fd9\u91cc\u7b80\u5355\u8bb2\u4e0b\u6211\u7684\u601d\u8def\uff1a"),Object(c.b)("ol",null,Object(c.b)("li",{parentName:"ol"},"\u5728\u4ee3\u7801\u4ed3\u5e93\u4e0b\u521b\u5efa\u6570\u636e\u5e93\u811a\u672c\u7684\u4ed3\u5e93\u8fdb\u884c\u811a\u672c\u7684\u7ef4\u62a4"),Object(c.b)("li",{parentName:"ol"},"\u6bcf\u4e2a\u7cfb\u7edf\u4e00\u4e2a\u6587\u4ef6\u5939,\u6587\u4ef6\u5939\u4e0b\u653e\u5165\u7cfb\u7edf\u82f1\u6587\u540d\u79f0.sql\u7684\u6587\u4ef6(\u6bd4\u5982\u8ba2\u5355\u7cfb\u7edf\u53eboms\uff0c\u5219\u811a\u672c\u6587\u4ef6\u7684\u540d\u79f0\u4e3aoms.sql)"),Object(c.b)("li",{parentName:"ol"},"\u811a\u672c\u6587\u4ef6\u4e2d\u53ea\u653e\u521b\u5efa\u8868\u8bed\u53e5\uff0c\u6bcf\u6b21\u811a\u672c\u7684\u4fee\u6539\uff0c\u53ea\u662f\u5bf9\u8868\u3001\u5217\u7684\u5c5e\u6027\u505a\u589e\u5220\u6539\u3002")),Object(c.b)("p",null,"\u57fa\u4e8e\u4ee5\u4e0a\uff0c\u5b9e\u9645\u9700\u8981\u7684\u80fd\u591f\u89e3\u6790DDL\u4e2d\u5efa\u8868\u8bed\u53e5\u7684\u5de5\u5177\uff0c\u901a\u8fc7\u5bf9\u6bd4\u4e24\u4e2a\u7248\u672c\u7684DDL\u751f\u6210\u5bf9\u5e94\u7684diff\u6587\u4ef6\u3002\u57fa\u4e8e\u8fd9\u6837\u7684\u8bc9\u6c42\uff0c\u5728github\u4e0a\u627e\u5230\u4e86\u8fd9\u6837\u7684\u5de5\u5177\uff0c\u5de5\u5177\u7684\u540d\u79f0\u53eb",Object(c.b)("a",Object(a.a)({parentName:"p"},{href:"https://github.com/schemalex/schemalex"}),"schemalex")),Object(c.b)("h2",{id:"\u5b9e\u8df5"},"\u5b9e\u8df5"),Object(c.b)("ol",null,Object(c.b)("li",{parentName:"ol"},"\u672c\u5730\u73af\u5883\u521b\u5efa\u4e2a\u6587\u4ef6\u5939\u5e76\u521d\u59cb\u5316git\u4ed3\u5e93")),Object(c.b)("pre",null,Object(c.b)("code",Object(a.a)({parentName:"pre"},{className:"language-bash"}),"$ mkdir demo\n$ cd demo\n$ git init\n\n")),Object(c.b)("ol",{start:2},Object(c.b)("li",{parentName:"ol"},"\u521b\u5efademo.sql\u6587\u4ef6\uff0c\u521d\u59cb\u6570\u636e\u4e3a")),Object(c.b)("pre",null,Object(c.b)("code",Object(a.a)({parentName:"pre"},{className:"language-sql"}),"CREATE TABLE student (\n id INTEGER NOT NULL AUTO_INCREMENT,\n    PRIMARY KEY (id)\n);\n\n\n")),Object(c.b)("ol",{start:3},Object(c.b)("li",{parentName:"ol"},"\u5c06demo.sql\u6587\u4ef6\u4fdd\u5b58\u5230\u672c\u5730\u5de5\u4f5c\u533a\u5e76\u6253\u4e0atag")),Object(c.b)("pre",null,Object(c.b)("code",Object(a.a)({parentName:"pre"},{className:"language-bash"}),"git add .\ngit commit -m 'add demo.sql'\ngit tag -a v1.0 -m 'add demo.sql'\n")),Object(c.b)("ol",{start:4},Object(c.b)("li",{parentName:"ol"},"\u4fee\u6539demo.sql\uff0c\u4fee\u6539\u540e\u7684\u6570\u636e\u4e3a")),Object(c.b)("pre",null,Object(c.b)("code",Object(a.a)({parentName:"pre"},{className:"language-sql"}),'CREATE TABLE student (\n    id INTEGER NOT NULL AUTO_INCREMENT,\n    name VARCHAR (64) NOT NULL DEFAULT "",\n    PRIMARY KEY (id)\n);\n\nCREATE TABLE course (\n    id INTEGER NOT NULL AUTO_INCREMENT,\n    name VARCHAR (64) NOT NULL DEFAULT "",\n    PRIMARY KEY (id)\n);\n')),Object(c.b)("ol",{start:5},Object(c.b)("li",{parentName:"ol"},"\u4fdd\u5b58\u6587\u4ef6\u5230\u672c\u5730\u5de5\u4f5c\u533a")),Object(c.b)("pre",null,Object(c.b)("code",Object(a.a)({parentName:"pre"},{className:"language-sql"}),"git add .\ngit commit -m 'modify demo.sql'\n\n")),Object(c.b)("ol",{start:6},Object(c.b)("li",{parentName:"ol"},"\u6267\u884c\u811a\u672c",Object(c.b)("inlineCode",{parentName:"li"},"./gen.sh /root/demo demo"),"\uff0c\u811a\u672c\u7684\u7b2c\u4e00\u4e2a\u53c2\u6570\u4e3a\u6570\u636e\u5e93\u811a\u672c\u6587\u4ef6\u5939\u7684\u5168\u8def\u5f84\uff0c\u7b2c\u4e8c\u4e2a\u53c2\u6570\u4e3a\u6570\u636e\u5e93\u811a\u672c\u540d\u79f0")),Object(c.b)("pre",null,Object(c.b)("code",Object(a.a)({parentName:"pre"},{className:"language-bash"}),'#!/bin/bash\n#\nset -e\n\ndst_dir=$1\nsys_name=$2\nif [ -z "$sys_name" ]; then\n    echo "usage gen_script.sh dst_dir sys_name"\n    exit 1\nfi\n\nscript_file=${sys_name}.sql\n\ncur_dir=$(pwd)\ncd "$dst_dir"\n\nif [ ! -f "$script_file" ]; then\n    echo "$script_file not be found"\n    exit 1\nfi\n\n\n# test git command\nif ! command -v git &> /dev/null; then\n    echo "git cound not be found"\n    exit 1\nfi\n\n\n\nif ! git checkout master &> /dev/null; then\n    echo "checkout master failed"\n    exit 1\nfi\n\ncurrent_file=$(mktemp)\n\nif ! cp "$script_file" "$current_file" &> /dev/null; then\n    echo "copy $script_file $current_file failed"\n    exit 1\nfi\n\n\n# list latest tag\nlatest_tag=$(git describe --tags "$(git rev-list --tags --max-count=1)")\n\nif [ -z "$latest_tag" ]; then\n    echo "current repo no tag."\n    exit 1\nfi\n\nif ! git checkout "$latest_tag" &> /dev/null; then\n    echo "checkout tags failed"\n    exit 1\nfi\n\ntag_file=$(mktemp)\nif ! cp "$script_file" "$tag_file" &> /dev/null; then\n    echo "copy $script_file $tag_file failed"\n    exit 1\nfi\n\nrollback=$(schemalex "$current_file" "$tag_file" )\necho "$rollback" > "$cur_dir"/rollback.sql\n\ndiff=$(schemalex "$tag_file" "$current_file" )\necho "$diff" > "$cur_dir"/diff.sql\n\n')),Object(c.b)("ol",{start:7},Object(c.b)("li",{parentName:"ol"},"\u6700\u7ec8\u4f1a\u751f\u6210\u4e24\u4e2a\u6587\u4ef6:diff.sql\u548crollback.sql")),Object(c.b)("ul",null,Object(c.b)("li",{parentName:"ul"},"diff.sql")),Object(c.b)("pre",null,Object(c.b)("code",Object(a.a)({parentName:"pre"},{className:"language-sql"}),"BEGIN;\n\nSET FOREIGN_KEY_CHECKS = 0;\n\nCREATE TABLE `course` (\n`id` INT (11) NOT NULL AUTO_INCREMENT,\n`name` VARCHAR (64) NOT NULL DEFAULT '',\nPRIMARY KEY (`id`)\n);\n\nALTER TABLE `student` ADD COLUMN `name` VARCHAR (64) NOT NULL DEFAULT '' AFTER `id`;\n\nSET FOREIGN_KEY_CHECKS = 1;\n\nCOMMIT;\n")),Object(c.b)("ul",null,Object(c.b)("li",{parentName:"ul"},"rollback.sql")),Object(c.b)("pre",null,Object(c.b)("code",Object(a.a)({parentName:"pre"},{className:"language-sql"}),"BEGIN;\n\nSET FOREIGN_KEY_CHECKS = 0;\n\nDROP TABLE `course`;\n\nALTER TABLE `student` DROP COLUMN `name`;\n\nSET FOREIGN_KEY_CHECKS = 1;\n\nCOMMIT;\n")),Object(c.b)("h2",{id:"\u7ed3\u8bed"},"\u7ed3\u8bed"),Object(c.b)("p",null,"\u867d\u7136schemalex\u5bf9\u811a\u672c\u8bed\u53e5\u4e0a\u6709\u4e00\u4e9b\u9650\u5236\uff0c\u4f46\u662f\u57fa\u672c\u6ee1\u8db3\u4e86\u6211\u5bf9\u6570\u636e\u5e93\u7248\u672c\u7ba1\u7406\u7684\u8bc9\u6c42\uff0c\u4ee5\u4e0a\u662f\u6211\u5728\u6570\u636e\u5e93\u7248\u672c\u7ba1\u7406\u4e0a\u7684\u4e00\u4e9b\u5b9e\u8df5\uff0c\u4f9b\u5404\u4f4d\u53c2\u8003\u3002"),Object(c.b)("h3",{id:"\u8054\u7cfb\u65b9\u5f0f"},"\u8054\u7cfb\u65b9\u5f0f"),Object(c.b)("ul",null,Object(c.b)("li",{parentName:"ul"},"\u6b22\u8fce\u8ba2\u9605\u6211\u7684\u516c\u4f17\u53f7\uff0c\u8fd9\u91cc\u4e3b\u8981\u4f1a\u53d1\u8868\u4e9b\u8f6f\u4ef6\u5de5\u7a0b\u4e0a\u7684\u4e00\u4e9b\u60f3\u6cd5\u53ca\u5b9e\u8df5\n",Object(c.b)("img",{alt:"\u5fae\u4fe1\u516c\u4f17\u53f7",src:n(101).default}))))}s.isMDXComponent=!0}}]);